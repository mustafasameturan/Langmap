name: Deploy Langmap to Ubuntu Server

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Manuel tetikleme imkanÄ±

env:
  PROJECT_PATH: /home/mst-projects/fe/Langmap

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # GitHub environment protection
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4  # v2 yerine gÃ¼ncel versiyon
      
    - name: Pre-deployment System Check
      uses: appleboy/ssh-action@v1.0.0  # master yerine sabit versiyon
      with:
        host: ${{ secrets.UBUNTU_HOST }}
        username: ${{ secrets.UBUNTU_USERNAME }}
        key: ${{ secrets.UBUNTU_SSH_KEY }}
        port: 1453
        timeout: 30s
        script: |
          echo "ğŸ” Pre-deployment system checks..."
          
          # Disk space kontrolÃ¼
          DISK_USAGE=$(df /home | tail -1 | awk '{print $5}' | sed 's/%//')
          if [ $DISK_USAGE -gt 85 ]; then
            echo "âŒ ERROR: Disk usage is ${DISK_USAGE}%. Deployment aborted!"
            exit 1
          fi
          echo "âœ… Disk usage: ${DISK_USAGE}% (OK)"
          
          # Memory kontrolÃ¼
          FREE_MEM=$(free | awk 'FNR==2{printf "%.1f", $7/1024/1024}')
          echo "âœ… Available memory: ${FREE_MEM}GB"
          
          # Docker servis kontrolÃ¼
          if ! systemctl is-active docker >/dev/null 2>&1; then
            echo "âŒ Docker service is not running!"
            exit 1
          fi
          echo "âœ… Docker service is running"
          
          echo "ğŸ¯ System checks completed successfully"

    - name: Deploy Application
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.UBUNTU_HOST }}
        username: ${{ secrets.UBUNTU_USERNAME }}
        key: ${{ secrets.UBUNTU_SSH_KEY }}
        port: 1453
        command_timeout: 15m  # Timeout eklendi
        script: |
          cd ${{ env.PROJECT_PATH }}
          
          echo "ğŸš€ Starting deployment process..."
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ• Time: $(date)"
          
          # Git gÃ¼ncellemesi
          echo "ğŸ“¥ Pulling latest changes..."
          git stash --include-untracked >/dev/null 2>&1 || true
          git pull origin master
          
          # Portainer ayarlarÄ±nÄ± korumak iÃ§in container'larÄ± graceful shutdown
          echo "ğŸ›‘ Gracefully stopping containers..."
          docker compose down --timeout 45
          
          # Yeni container'larÄ± baÅŸlat
          echo "ğŸ”„ Starting updated containers..."
          docker compose up -d --build --force-recreate --remove-orphans
          
          # Container'larÄ±n baÅŸlamasÄ±nÄ± bekle
          echo "â³ Waiting for containers to be ready..."
          sleep 30
          
          # Container durumlarÄ±nÄ± kontrol et
          echo "ğŸ“Š Container status:"
          docker compose ps
          
          echo "âœ… Deployment process completed!"

    - name: Cleanup Resources
      uses: appleboy/ssh-action@v1.0.0
      if: always()  # Her durumda Ã§alÄ±ÅŸtÄ±r
      with:
        host: ${{ secrets.UBUNTU_HOST }}
        username: ${{ secrets.UBUNTU_USERNAME }}
        key: ${{ secrets.UBUNTU_SSH_KEY }}
        port: 1453
        script: |
          cd ${{ env.PROJECT_PATH }}
          
          echo "ğŸ§¹ Cleaning up resources..."
          
          # KullanÄ±lmayan image'larÄ± temizle
          docker image prune -f
          
          # KullanÄ±lmayan volume'larÄ± temizle (dikkatli)
          docker volume prune -f
          
          # Eski backup'larÄ± temizle (30 gÃ¼nden eski)
          find backups/ -type f -mtime +30 -delete 2>/dev/null || true
          find backups/ -type d -empty -delete 2>/dev/null || true
          
          # Build cache'i temizle (haftalÄ±k)
          if [ $(date +%u) -eq 1 ]; then  # Pazartesi
            echo "ğŸ“… Weekly deep clean..."
            docker builder prune -af --filter until=168h  # 7 gÃ¼n
          fi
          
          echo "âœ… Cleanup completed"

    - name: Post-deployment Summary
      if: always()
      run: |
        echo "ğŸ“‹ Deployment Summary"
        echo "===================="
        echo "ğŸ·ï¸  Repository: ${{ github.repository }}"
        echo "ğŸ“¦ Commit: ${{ github.sha }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "ğŸ• Time: $(date)"
        echo "ğŸ“ˆ Status: ${{ job.status }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ”— Application URL: ${{ env.HEALTH_CHECK_URL }}"
        else
          echo "âŒ Deployment failed - Check logs above"
        fi    
